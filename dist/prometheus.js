!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self).Prometheus=t()}(this,function(){"use strict";class r{constructor(e,t,s){this.name=e,this.version=t,this.os=s}toString(){return`${this.name} ${this.version} `+this.os}}class e{constructor(e){this.version=e,this.name="node",this.os=process.platform}toString(){return this.name+" "+this.os}}class o{constructor(){this.bot=!0,this.name="bot",this.version=null,this.os=null}toString(){return""+this.name}}const a=[["aol",/AOLShield\/([0-9\._]+)/],["edge",/Edge?\/([0-9\._]+)/],["yandexbrowser",/YaBrowser\/([0-9\._]+)/],["vivaldi",/Vivaldi\/([0-9\.]+)/],["kakaotalk",/KAKAOTALK\s([0-9\.]+)/],["samsung",/SamsungBrowser\/([0-9\.]+)/],["chrome",/(?!Chrom.*OPR)Chrom(?:e|ium)\/([0-9\.]+)(:?\s|$)/],["phantomjs",/PhantomJS\/([0-9\.]+)(:?\s|$)/],["crios",/CriOS\/([0-9\.]+)(:?\s|$)/],["firefox",/Firefox\/([0-9\.]+)(?:\s|$)/],["fxios",/FxiOS\/([0-9\.]+)/],["opera",/Opera\/([0-9\.]+)(?:\s|$)/],["opera",/OPR\/([0-9\.]+)(:?\s|$)$/],["ie",/Trident\/7\.0.*rv\:([0-9\.]+).*\).*Gecko$/],["ie",/MSIE\s([0-9\.]+);.*Trident\/[4-7].0/],["ie",/MSIE\s(7\.0)/],["bb10",/BB10;\sTouch.*Version\/([0-9\.]+)/],["android",/Android\s([0-9\.]+)/],["ios",/Version\/([0-9\._]+).*Mobile.*Safari.*/],["safari",/Version\/([0-9\._]+).*Safari/],["facebook",/FBAV\/([0-9\.]+)/],["instagram",/Instagram\s([0-9\.]+)/],["ios-webview",/AppleWebKit\/([0-9\.]+).*Mobile/],["searchbot",/alexa|bot|crawl(er|ing)|facebookexternalhit|feedburner|google web preview|nagios|postrank|pingdom|slurp|spider|yahoo!|yandex/]],l=[["iOS",/iP(hone|od|ad)/],["Android OS",/Android/],["BlackBerry OS",/BlackBerry|BB10/],["Windows Mobile",/IEMobile/],["Amazon OS",/Kindle/],["Windows 3.11",/Win16/],["Windows 95",/(Windows 95)|(Win95)|(Windows_95)/],["Windows 98",/(Windows 98)|(Win98)/],["Windows 2000",/(Windows NT 5.0)|(Windows 2000)/],["Windows XP",/(Windows NT 5.1)|(Windows XP)/],["Windows Server 2003",/(Windows NT 5.2)/],["Windows Vista",/(Windows NT 6.0)/],["Windows 7",/(Windows NT 6.1)/],["Windows 8",/(Windows NT 6.2)/],["Windows 8.1",/(Windows NT 6.3)/],["Windows 10",/(Windows NT 10.0)/],["Windows ME",/Windows ME/],["Open BSD",/OpenBSD/],["Sun OS",/SunOS/],["Linux",/(Linux)|(X11)/],["Mac OS",/(Mac_PowerPC)|(Macintosh)/],["QNX",/QNX/],["BeOS",/BeOS/],["OS/2",/OS\/2/],["Search Bot",/(nuhk)|(Googlebot)|(Yammybot)|(Openbot)|(Slurp)|(MSNBot)|(Ask Jeeves\/Teoma)|(ia_archiver)/]],d=3;function n(){if("undefined"==typeof navigator)return"undefined"!=typeof process&&process.version?new e(process.version.slice(1)):null;{var i=navigator.userAgent,t=""!==i&&a.reduce((e,[t,s])=>{if(e)return e;e=s.exec(i);return!!e&&[t,e]},!1);if(!t)return null;const[s,n]=t;if("searchbot"===s)return new o;let e=n[1]&&n[1].split(/[._]/).slice(0,3);return e?e.length<d&&(e=[...e,...new Array(d-e.length).fill("0")]):e=[],new r(s,e.join("."),function(t){var e=l.find(([,e])=>e.test(t));return e?e[0]:null}(i))}}function i(){var{referrer:e,title:t}=document,s=n().toString(),i=(console.log(s),document.location.origin);return{title:t,url:i,timestamp:Date.now().toString(),referrer:e,userAgent:s}}function h(){var{origin:e,pathname:t}=document.location;return console.log("url is:",e+t),e+t}const s="http://120.55.12.109:8080/v1/api/upload/";var t="requestIdleCallback"in window;function c(e){const t=e instanceof Array?e:new Array(e);console.log("sendBeacon",t),navigator&&navigator.sendBeacon&&t.forEach(e=>{var t=s+e.type,e=JSON.stringify(e);navigator.sendBeacon(t,e)})}const u=new Array;function p(e){console.log("addTask",e),u.push(e)}function m(){const e=new Date;var t=parseInt(""+e.getFullYear()+g(e.getMonth()+1,2)+g(e.getDate(),2),10).toString(16),s=parseInt(""+g(e.getHours(),2)+g(e.getMinutes(),2)+g(e.getSeconds(),2)+g(e.getMilliseconds(),3),10).toString(16);let i=t+s.length+s;for(;i.length<32;)i+=Math.floor(16*Math.random()).toString(16);return`${i.slice(0,8)}-${i.slice(8,16)}-`+i.slice(16)}function g(e,t,s="0"){return String(e).padStart(t,s)}t&&window.requestIdleCallback(function e(t){for(var s=t.timeRemaining();0<s&&u.length;)c(u.shift());window.requestIdleCallback(e,{timeout:500})},{timeout:500});let f,w;function y(){f.destroySession(),f=new S}function v(e){var t=h(),s=localStorage.getItem("prometheus_uuid"),t=Object.assign(Object.assign({},i()),{behaviorType:"staytime",type:"behavior",pageURL:t,stayTime:e,uuid:s});e=t,c([...u,e])}class S{constructor(e=30){this.sid=m(),this.sendPvTimer=null,this.visitEndTime=null,this.viewFlag=!1,this.handleVisChange=()=>{this.handlePageVisibility()},this.handleBeforeUnload=()=>{this.sendPvTimer?clearTimeout(this.sendPvTimer):v(Date.now()-this.visitStartTime)},this.timeLimit=e,this.handlePageVisibility(),this.initListener(),sessionStorage.setItem("prometheus_sid",this.sid)}initListener(){document.addEventListener("visibilitychange",this.handleVisChange),window.addEventListener("beforeunload",this.handleBeforeUnload)}handlePageVisibility(){document.hidden?this.viewFlag&&(clearTimeout(this.sendPvTimer),this.refreshSession(),this.visitEndTime=Date.now()):this.viewFlag&&!this.isExpired()||(this.viewFlag||(this.viewFlag=!0),this.visitEndTime&&v(this.visitEndTime-this.visitStartTime),this.visitStartTime=Date.now(),this.startSendPvTimer())}startSendPvTimer(){clearTimeout(this.sendPvTimer),this.sendPvTimer=setTimeout(()=>{var e,t;e=h(),t=localStorage.getItem("prometheus_uuid"),e=Object.assign(Object.assign({},i()),{behaviorType:"pv",type:"behavior",pageURL:e,uuid:t}),console.log("sendPv",e),p(e)},3e3)}isExpired(){return+sessionStorage.getItem(this.sid)<Date.now()}refreshSession(){var e=""+(Date.now()+1e3*this.timeLimit*60);sessionStorage.setItem(this.sid,e)}destroySession(){localStorage.removeItem(this.sid),document.removeEventListener("visibilitychange",this.handleVisChange),window.removeEventListener("beforeunload",this.handleBeforeUnload)}}class _{constructor(){if(this.oldUrl=h(),_.instance)return _.instance;(_.instance=this).initPopStateListener(),this.rewritePushState(),this.rewriteReplaceState()}initPopStateListener(){window.addEventListener("popstate",e=>{console.log(this);var t=location.href;console.log("[popState] newUrl:",t,"oldUrl:",this.oldUrl,t===this.oldUrl),t!==this.oldUrl&&(this.oldUrl=t,y())})}rewritePushState(){if(history.pushState){const i=history.pushState;history.pushState=(e,t,s)=>{s!==this.oldUrl&&(this.oldUrl=s instanceof URL?s.toString():document.location.origin+"/"+s,i.call(history,e,t,s),y())}}}rewriteReplaceState(){if(history.replaceState){const i=history.replaceState;history.replaceState=(e,t,s)=>{s!==this.oldUrl&&(this.oldUrl=s instanceof URL?s.toString():document.location.origin+"/"+s,i.call(history,e,t,s),y())}}}}function b(e,t){e=Object.assign(Object.assign({},i()),{type:"api",apiType:e,method:t.method,pathUrl:t.pathUrl,success:t.success,status:t.status,duration:t.duration,requestHeader:t.requestHeader,requestBody:t.requestBody,responseHeader:t.responseHeader,responseBody:t.responseBody});console.log("sendHttpRequest",e),p(e)}function x(){{var n=b;let e=window.XMLHttpRequest;if(!0!==e._myxhr_flag){e._myxhr_flag=!0;let r=e.prototype.open,t=(e.prototype.open=function(e,t,s,i,n){return this._myxhr_xhr_info={type:"api",apiType:"xhr",pathUrl:t,method:e,status:null},r.apply(this,arguments)},e.prototype.send);e.prototype.send=function(s){let i=this;this._myxhr_start_time=Date.now();var e=t=>()=>{if(i.response){let e=null;switch(i.responseType){case"json":e=JSON&&JSON.stringify(i.response).length;break;case"blob":case"moz-blob":e=i.response.size;break;case"arraybuffer":e=i.response.byteLength;break;case"document":e=i.response.documentElement&&i.response.documentElement.innerHTML&&i.response.documentElement.innerHTML.length+28;break;default:e=i.response.length}i._myxhr_xhr_info.event=t,i._myxhr_xhr_info.status=i.status,i._myxhr_xhr_info.success=200<=i.status&&i.status<=206||304===i.status,i._myxhr_xhr_info.duration=Date.now()-i._myxhr_start_time,i._myxhr_xhr_info.responseSize=e,i._myxhr_xhr_info.requestSize=s?s.length:0,i._myxhr_xhr_info.type="xhr",i._myxhr_xhr_info.responseHeader=i.getAllResponseHeaders(),i._myxhr_xhr_info.responseBody=self.Response,i._myxhr_xhr_info.requestHeader="",i._myxhr_xhr_info.requestBody="",n("xhr",this._myxhr_xhr_info)}};return this.addEventListener("load",e("load"),!1),this.addEventListener("error",e("error"),!1),this.addEventListener("abort",e("abort"),!1),t.apply(this,arguments)}}}var a=b;if(window.fetch){let o=window.fetch;window.fetch=function(){let t=Date.now();var e=[].slice.call(arguments),s=e[0];let i="GET",n,r=("string"==typeof s?n=s:"Request"in window&&s instanceof window.Request?(n=s.url,s.method&&(i=s.method)):n=""+s,{type:"api",apiType:"fetch",method:i=e[1]&&e[1].method?e[1].method:i,pathUrl:n,status:null});return o.apply(this,e).then(function(e){return r.status=e.status,r.duration=Date.now()-t,r.success=e.ok,r.responseHeader=e.headers,a("fetch",r),e})}}}return class{constructor(e){this.init(e)}init(e){this.initUuid(),this.initError(),this.initHttp(),this.initPv()}initUuid(){var e;localStorage.getItem("prometheus_uuid")||(e=m(),localStorage.setItem("prometheus_uuid",e))}initPv(){f=new S,w=new _}initError(){window.addEventListener("error",e=>{var t=e.target;t&&(t.src||t.href)?(t=Object.assign(Object.assign({},i()),{type:"error",errorType:"resouceError",filename:t.src||t.href,errorMessage:e.message,tagName:t.tagName,time:e.timeStamp,size:"0"}),console.log("sendResouceError",t),p(t)):(console.log(e),t=Object.assign(Object.assign({},i()),{type:"error",errorType:"jsError",message:e.message,stack:e.error.stack}),console.log("sendJsError",t),p(t))},!0),window.addEventListener("unhandledrejection",e=>{var t=e.reason,e=(console.log(e),Object.assign(Object.assign({},i()),{type:"error",errorType:"jsError",message:t.message,stack:t.stack}));console.log("sendJsError",e),p(e)})}initHttp(){x()}}});
